#!/bin/sh

#æ˜¾ç¤ºlogo
art_text=$(cat <<'EOF'
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                               â”‚
â”‚                 [0;1;32;92mâ–„[0m             [0;1;36;96mâ–€[0m                               â”‚
â”‚ [0;1;33;93mâ–„[0m [0;1;32;92mâ–„[0;1;36;96mâ–„[0m    [0;1;35;95mâ–„[0;1;31;91mâ–„â–„[0m   [0;1;32;92mâ–„[0;1;36;96mâ–„â–ˆ[0;1;34;94mâ–„â–„[0m  [0;1;31;91mâ–„â–„[0;1;33;93mâ–„â–„[0m   [0;1;36;96mâ–„[0;1;34;94mâ–„â–„[0m     [0;1;33;93mâ–„[0;1;32;92mâ–„â–„[0m    [0;1;35;95mâ–„[0m [0;1;31;91mâ–„â–„[0m   [0;1;32;92mâ–„[0;1;36;96mâ–„â–„[0m    [0;1;31;91mâ–„â–„[0;1;33;93mâ–„[0m  â”‚
â”‚ [0;1;32;92mâ–ˆ[0;1;36;96mâ–€[0m  [0;1;34;94mâ–ˆ[0m  [0;1;31;91mâ–€[0m   [0;1;32;92mâ–ˆ[0m    [0;1;34;94mâ–ˆ[0m    [0;1;33;93mâ–ˆâ–€[0m [0;1;32;92mâ–€[0;1;36;96mâ–ˆ[0m    [0;1;35;95mâ–ˆ[0m    [0;1;32;92mâ–ˆâ–€[0m  [0;1;34;94mâ–ˆ[0m   [0;1;31;91mâ–ˆâ–€[0m  [0;1;32;92mâ–€[0m [0;1;36;96mâ–ˆâ–€[0m  [0;1;35;95mâ–€[0m  [0;1;31;91mâ–ˆ[0;1;33;93mâ–€[0m  [0;1;32;92mâ–ˆ[0m â”‚
â”‚ [0;1;36;96mâ–ˆ[0m   [0;1;35;95mâ–ˆ[0m  [0;1;33;93mâ–„â–€[0;1;32;92mâ–€â–€[0;1;36;96mâ–ˆ[0m    [0;1;35;95mâ–ˆ[0m    [0;1;32;92mâ–ˆ[0m   [0;1;34;94mâ–ˆ[0m    [0;1;31;91mâ–ˆ[0m    [0;1;36;96mâ–ˆâ–€[0;1;34;94mâ–€â–€[0;1;35;95mâ–€[0m   [0;1;33;93mâ–ˆ[0m     [0;1;34;94mâ–ˆ[0m      [0;1;33;93mâ–ˆ[0;1;32;92mâ–€â–€[0;1;36;96mâ–€â–€[0m â”‚
â”‚ [0;1;34;94mâ–ˆ[0m   [0;1;31;91mâ–ˆ[0m  [0;1;32;92mâ–€â–„[0;1;36;96mâ–„â–€[0;1;34;94mâ–ˆ[0m    [0;1;31;91mâ–€[0;1;33;93mâ–„â–„[0m  [0;1;36;96mâ–ˆâ–ˆ[0;1;34;94mâ–„â–ˆ[0;1;35;95mâ–€[0m  [0;1;31;91mâ–„[0;1;33;93mâ–„â–ˆ[0;1;32;92mâ–„â–„[0m  [0;1;34;94mâ–€â–ˆ[0;1;35;95mâ–„â–„[0;1;31;91mâ–€[0m   [0;1;32;92mâ–ˆ[0m     [0;1;35;95mâ–€â–ˆ[0;1;31;91mâ–„â–„[0;1;33;93mâ–€[0m  [0;1;32;92mâ–€[0;1;36;96mâ–ˆâ–„[0;1;34;94mâ–„â–€[0m â”‚
â”‚                      [0;1;34;94mâ–ˆ[0m                                        â”‚
â”‚                      [0;1;35;95mâ–€[0m                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
EOF
)

# æ‰“å° ASCII è‰ºæœ¯æ–‡æœ¬
echo "$art_text"
echo "æ¬¢è¿ä½¿ç”¨æœ¬è„šæœ¬,è„šæœ¬ç‰ˆæœ¬:1.0"
# echo "æµ‹è¯•ç‰ˆæ–½å·¥æ ‡å¿—ï¼Œéæµ‹è¯•äººå‘˜ç­‰å¾…æ­£å¼ç‰ˆ" #æµ‹è¯•æ ‡å¿—ä¸è¦åˆ é™¤ï¼Œæ­£å¼ç‰ˆæ‰“ä¸Šæ³¨é‡Š
echo "åˆ¶ä½œ:çšæœˆè¿å¼€å‘ç»„"
echo "çšæœˆè¿å®˜ç½‘ï¼šhttps://www.natpierce.cn"
echo "è¿è¡Œè„šæœ¬æƒé™è¦æ±‚ï¼šå¯ä»¥ä½¿ç”¨dockerå‘½ä»¤çš„ç”¨æˆ·ï¼Œå¦‚æœæƒé™ä¸è¶³å¯ä»¥ä½¿ç”¨sudoè¿è¡Œè„šæœ¬"
echo "ç¯å¢ƒæ£€æŸ¥å¼€å§‹"

# ç¯å¢ƒæ£€æŸ¥
# æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯rootï¼Œå¦‚æœä¸æ˜¯åˆ™é€€å‡º
if [ "$(id -u)" -ne 0 ]; then
   echo "é”™è¯¯ï¼šè„šæœ¬éœ€è¦ä»¥rootç”¨æˆ·è¿è¡Œã€‚"
   exit 1
fi

# å¦‚æœè„šæœ¬ä»¥rootç”¨æˆ·è¿è¡Œï¼Œåˆ™ç»§ç»­æ‰§è¡Œä»¥ä¸‹ä»£ç 
echo "è„šæœ¬æ­£åœ¨ä»¥rootç”¨æˆ·è¿è¡Œã€‚"
# æ£€æŸ¥wgetæ˜¯å¦å®‰è£…
if ! command -v wget > /dev/null 2>&1; then
    echo "é”™è¯¯ï¼šwgetå°šæœªå®‰è£…ã€‚è¯·å®‰è£…wgetä»¥ç»§ç»­ã€‚"
    exit 1
else
    echo "wgetå·²å®‰è£…ã€‚"
fi

# æ£€æŸ¥dockeræ˜¯å¦å®‰è£…
if ! command -v docker > /dev/null 2>&1; then
    printf "é”™è¯¯ï¼šDockerå°šæœªå®‰è£…ã€‚è¯·å®‰è£…Dockerä»¥ç»§ç»­ã€‚"
    exit 1
else
    echo "Dockerå·²å®‰è£…ã€‚"
fi


#æœ€æ–°ç‰ˆæœ¬å·
echo "å¼€å§‹è·å–å®˜ç½‘æœ€æ–°ç‰ˆæœ¬å·"


# ç½‘ç«™çš„URL
url="https://natpierce.oss-cn-beijing.aliyuncs.com/update/version.txt"

# ä½¿ç”¨wgetè·å–ç‰ˆæœ¬å·
version=$(wget -qO- "$url")

if [ -n "$version" ]; then
  echo "å½“å‰ç‰ˆæœ¬å·: $version"
else
  echo "æ— æ³•æ‰¾åˆ°ç‰ˆæœ¬å·"
fi

#version="0.1" #ç‰ˆæœ¬å·å¼‚å¸¸æµ‹è¯•

#ç”¨æˆ·é€šè¿‡è¾“å…¥yeså’Œno,æ¥ç¡®è®¤æ˜¯å¦ä¸‹è½½

while true; do
  printf "è¯·è¾“å…¥ 'yes' æˆ– 'no' æ¥ç¡®è®¤æ˜¯å¦ç»§ç»­: "
  read user_input

  case "$user_input" in
    [Yy][Ee][Ss])
      echo "æ‚¨é€‰æ‹©äº†ç»§ç»­ã€‚"
      break
      ;;
    [Nn][Oo])
      echo "æ‚¨é€‰æ‹©äº†ä¸ç»§ç»­ã€‚"
      exit 0
      ;;
    *)
      echo "æ— æ•ˆçš„è¾“å…¥ï¼Œè¯·è¾“å…¥ 'yes' æˆ– 'no'ã€‚"
      ;;
  esac
done



# å®šä¹‰ä¸åŒæ¶æ„çš„ä¸‹è½½é“¾æ¥å’Œé•œåƒæ ‡ç­¾
URL_AMD64="https://natpierce.oss-cn-beijing.aliyuncs.com/docker/natpierce-amd64-v${version}.tar"
URL_ARM64="https://natpierce.oss-cn-beijing.aliyuncs.com/docker/natpierce-arm64-v${version}.tar"
URL_ARM32="https://natpierce.oss-cn-beijing.aliyuncs.com/docker/natpierce-arm32-v${version}.tar"
TAG_AMD64="xiyu505/natpierce:amd64"
TAG_ARM64="xiyu505/natpierce:arm64"
TAG_ARM32="xiyu505/natpierce:arm32"

# æ£€æµ‹ç³»ç»Ÿæ¶æ„
ARCH=$(uname -m)

# æ ¹æ®ç³»ç»Ÿæ¶æ„è®¾ç½®ä¸‹è½½é“¾æ¥å’Œé•œåƒæ ‡ç­¾
case $ARCH in
    x86_64)
        URL=$URL_AMD64
        TAG=$TAG_AMD64
        ;;
    aarch64|arm64)
        URL=$URL_ARM64
        TAG=$TAG_ARM64
        ;;
    armv7l)
        URL=$URL_ARM32
        TAG=$TAG_ARM32
        ;;
    *)
        echo "ä¸æ”¯æŒçš„æ¶æ„: $ARCH"
        exit 1
        ;;
esac

# ä¸‹è½½ Docker é•œåƒ tar æ–‡ä»¶
echo "æ­£åœ¨ä¸‹è½½é€‚ç”¨äº $ARCH çš„ Docker é•œåƒ..."
wget -O natpierce.tar $URL

# æ£€æŸ¥ä¸‹è½½æ˜¯å¦æˆåŠŸ
if [ $? -ne 0 ]; then
    echo "ä¸‹è½½ Docker é•œåƒå¤±è´¥ã€‚"
    exit 1
fi

# å¯¼å…¥ Docker é•œåƒ
echo "æ­£åœ¨å¯¼å…¥ Docker é•œåƒ..."
docker load -i natpierce.tar

# æ£€æŸ¥å¯¼å…¥æ˜¯å¦æˆåŠŸ
if [ $? -ne 0 ]; then
    echo "å¯¼å…¥ Docker é•œåƒå¤±è´¥ã€‚"
    exit 1
fi

# æ¸…ç†ä¸‹è½½çš„ tar æ–‡ä»¶
rm natpierce.tar

# åˆ›å»ºå¹¶å¯åŠ¨ Docker å®¹å™¨
echo "æ­£åœ¨å¯åŠ¨ Docker å®¹å™¨..."
docker run --name natpierce -e webdkh=33272 -v natpierce_data:/natpierce  --restart=always --privileged=true --net=host -d $TAG
# runåé¢åŠ å…¥ -e è®¾å®šç¯å¢ƒå˜é‡ å¦‚-e webdkh=33272
# æ£€æŸ¥å®¹å™¨æ˜¯å¦å¯åŠ¨æˆåŠŸ
if [ $? -ne 0 ]; then
    echo "å¯åŠ¨ Docker å®¹å™¨å¤±è´¥ã€‚è¯·æ£€æŸ¥æ˜¯å¦å­˜åœ¨é‡å¤å®¹å™¨"
    exit 1
fi
echo "Dockerå®¹å™¨å¯åŠ¨æˆåŠŸ"
printf "è¿™é‡Œæ˜¯dockerç‰ˆæœ¬çš„ä»‹ç»æ–‡æœ¬ã€‚\nç‰¹æ€§ï¼š\nDockerå®¹å™¨å¯åŠ¨æˆåŠŸåwebé¢æ¿é»˜è®¤ç«¯å£å·33272ï¼Œå¦‚è¦æ›´æ”¹,ä¿®æ”¹å®¹å™¨çš„ç¯å¢ƒå˜é‡webdkh\nåœ¨æœ¬æœºä¸Šè®¿é—®http://127.0.0.1:33272å³å¯è®¿é—®çšæœˆè¿çš„webé¡µé¢,å±€åŸŸç½‘è®¿é—®è¯·æ›´æ¢ä¸ºå±€åŸŸç½‘ip\n"